<!DOCTYPE html>
<html>
  <head>
    <title>Epicby</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/css/styles.css">
    <link rel='stylesheet' href='//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css'>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
<script src="//cdn.jsdelivr.net/underscorejs/1.4.4/underscore-min.js" type="text/javascript"></script>
<script src="//cdn.jsdelivr.net/backbonejs/0.9.10/backbone-min.js" type="text/javascript"></script>

</head>
<body>
	<div class="container">
		<div class="row-fluid">
			<div class="span12">
				<h1>Welcome</h1>
			</div>
		</div>
		<div class="row-fluid" id="button"></div>
		<div class="row-fluid" id="main">
			<p>Upfo:</p>
			<ul id="upfo"></ul>
			<p>Not upfo:</p>
			<ul id="notupfo">
		</div>
		</div>
	</div><!-- container-->
</body>
<!--
unused, cant get the } to work?:

<% if (active === false) %> class="btn btn-primary"> <% else %> class="btn btn-warning">
<% } %> Chill

<% if (active === false) { %> See whos up for something <% } %> <% else { %>Cancel <% } %>
-->

<!-- TEMPLATES!!!! -->
<script type="text/template" id="button_t">
    <button id='active' <% if (active === false) %> class="btn btn-primary"> <% else %> class="btn btn-warning">
		<% if (active === false) %> YES! <% else %> naa naa na na<% %>
	</button>

	
</script>
<script type="text/template" id="friend_t">
    <tr><td><%= 'name' %></td><td><% 'location' %></td><td><% 'message' %></td></tr>
</script>
<script>
	$(function($){	
		
		var friendsData = [{name: "Juha", location: "Sydney", active: true},{name: "Jonne", location: "Stockholm", active: false},{name: "Jarkko", location: "Turku", active: false},{name: "Jesse", location: "London", active: true}];
		/*
		 * MODELS
		 */
		
		// The user represents the current user that is fetched from the database...
		var User = Backbone.Model.extend({
			urlRoot: '/api/users',
			// This idAttribute should set the identifier id
			// to the field facebook id
			idAttribute: 'fbId',
			defaults: {
				fbId: '761506933',
				name: 'Riku',
				location: 'Helsinki',
				active: false,
				message: '',
				friends: {}
			},
			/*
			initialize: function() {
				this.user = new User();
				this.user.url = '/users/' + req.fbid
			},*/
			
			toggleactive: function() {
				var activer = user.get('active');
				if (activer === true) {
					user.save({active : false});
					console.log('active set to false'); }
				else {
					user.save({active : true});
					console.log('active set to true');
				};
				console.log(user.get('name'));
			},
		});
		
		// The friendmodel represents one friend fetched from the database
		var Friend = Backbone.Model.extend({
			defaults: {
				name: "John",
				location: "Helsinki",
				active: true,
				message: "Golf at Pickala at 6ish?"
			}
		});
		
		
		/*
		 * COLLECTIONS
		 */
		
		//The FriendList is a collection of all friends the user has.
		var FriendsList = Backbone.Collection.extend({
			model: Friend
		});

		/*
		 * VIEWS
		 */
		
		var FriendView = Backbone.View.extend({
			tagName: "li",
			initalize: function() {
			},
			render: function() {
				$(this.el).html('<span>' + this.model.get('name') + ', ' + this.model.get('location') + ', ' + this.model.get('message') + '</span>');
				return this; 
			}
			
		});
		
		var ActiveView = Backbone.View.extend({
			el: "#button",
			template: _.template( $('#button_t').html()),
			
			events: {"click button#active" : 'toggleactive'},
			
			initialize: function() {
				this.model.on('change', this.replace, this);
				this.render(this);
			
			},
			
			render: function() {
				var attributes = user.toJSON();
				this.$el.append(this.template(attributes));	
				return this;
			},
			replace: function() {
				var attributes = user.toJSON();
				$('button#active').replaceWith(this.template(attributes));
			},
			
			toggleactive: function() {
				console.log(this.model);
				this.model.toggleactive();
			},	
		});
		
		//IsupfoView is the view that renders the friends that are upfo.
		var IsupfoView = Backbone.View.extend({
			el: "#upfo",
			
			//events: {"click button#active" : 'addFriend'},
			
			initialize: function() {
	
				this.collection.on('reset', this.render, this);
				this.model.on('change', this.render, this);
			},
			
			render: function() {
				
				var self = this;
				var isUpfo = this.collection.where({active: true});
				
				this.$el.html("");
				if (this.model.get("active")) {
					_.each(isUpfo, function(friend){
						self.$el.append(new FriendView({model:friend}).render().el);
					});
				}
				return this; //It's good to always return this from render() 
			}
				
		});
		
		//NotupfoView is the view that renders the friends that are NOT upfo.
		var NotupfoView = Backbone.View.extend({
			el: "#notupfo",
			
			//events: {"click button#active" : 'addFriend'},
			
			initialize: function() {
	
				this.collection.on('reset', this.render, this);
				this.model.on('change', this.render, this);
			},
			
			render: function() {
				
				var self = this;
				var notUpfo = this.collection.where({active: false});
				
				this.$el.html("");
				if (this.model.get("active")) {
					_.each(notUpfo, function(friend){
						self.$el.append(new FriendView({model:friend}).render().el);
					});
				}
				return this; //It's good to always return this from render() 
			}
				
		});
		
		
		//var mainView = new MainView();
		var user = new User();
		var friendsList = new FriendsList();
		var activeView = new ActiveView( {model: user} );
		var isupfoView = new IsupfoView({collection: friendsList, model: user});
		var notupfoView = new NotupfoView({collection: friendsList, model: user});
		friendsList.reset(friendsData);
	});
	  
</script>
</html>